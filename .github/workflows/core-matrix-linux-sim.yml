name: Core Matrix Linux Sim

on:
  workflow_dispatch:

jobs:
  setup_dep_runners:
    runs-on: ubuntu-22.04
    outputs:
      runners: ${{ steps.filter-runners.outputs.runners }}
      runners_present: ${{ steps.filter-runners.outputs.runners_present }}
    env:
      TESTING_FORMULAE: openssl@3
      HOMEBREW_DEPENDENT_SHARD_COUNT: "4"
      HOMEBREW_LINUX_RUNNER: ubuntu-latest
      HOMEBREW_MACOS_LONG_TIMEOUT: "false"
      GITHUB_RUN_ID: "12345"
      TEST_BRANCH: feat/parrallel-deb-test
      BREW_DIR: /tmp/brew
    steps:
      - name: Clone brew branch
        run: git clone --depth=1 --branch "$TEST_BRANCH" https://github.com/GunniBusch/brew.git "$BREW_DIR"

      - name: Bootstrap brew
        run: |
          cd "$BREW_DIR"
          bin/brew --version

      - name: Determine runners (core-like)
        id: determine-dependent-runners
        run: |
          cd "$BREW_DIR"
          bin/brew determine-test-runners --dependents --eval-all "$TESTING_FORMULAE"

      - name: Filter to Linux matrix rows only
        id: filter-runners
        run: |
          all_runners='${{ steps.determine-dependent-runners.outputs.runners }}'
          linux_runners=$(echo "$all_runners" | ruby -rjson -e '
            rows = JSON.parse(STDIN.read)
            linux_rows = rows.select do |r|
              runner = r.fetch("runner")
              runner.start_with?("ubuntu") || runner.include?("linux")
            end
            puts linux_rows.to_json
          ')
          echo "runners=$linux_runners" >> "$GITHUB_OUTPUT"
          if [[ "$linux_runners" == "[]" ]]; then
            echo "runners_present=false" >> "$GITHUB_OUTPUT"
          else
            echo "runners_present=true" >> "$GITHUB_OUTPUT"
          fi

  test_deps:
    needs: [setup_dep_runners]
    if: fromJson(needs.setup_dep_runners.outputs.runners_present)
    strategy:
      matrix:
        include: ${{ fromJson(needs.setup_dep_runners.outputs.runners) }}
      fail-fast: false
    runs-on: ubuntu-22.04
    env:
      TEST_BOT_DEPENDENTS_ARGS: --only-formulae-dependents --junit
      TESTED_FORMULAE: openssl@3
      TESTING_FORMULAE: ${{ matrix.testing_formulae }}
      TEST_BRANCH: feat/parrallel-deb-test
      BREW_DIR: /tmp/brew
    steps:
      - name: Clone brew branch
        run: git clone --depth=1 --branch "$TEST_BRANCH" https://github.com/GunniBusch/brew.git "$BREW_DIR"

      - name: Bootstrap brew
        run: |
          cd "$BREW_DIR"
          bin/brew --version

      - name: Test dependents (core-like invocation + shard args)
        run: |
          BOTTLES_DIR=/tmp/bottles
          mkdir -p "$BOTTLES_DIR"
          cd "$BOTTLES_DIR"
          xargs -t "$BREW_DIR/bin/brew" test-bot \
            --dry-run \
            --testing-formulae="$TESTING_FORMULAE" \
            --tested-formulae="$TESTED_FORMULAE" \
            --dependent-shard-count="${{ matrix.dependent_shard_count }}" \
            --dependent-shard-index="${{ matrix.dependent_shard_index }}" \
            <<<"$TEST_BOT_DEPENDENTS_ARGS"
