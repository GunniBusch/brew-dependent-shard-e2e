name: Core Matrix Linux Sim

on:
  workflow_dispatch:
    inputs:
      testing_formulae:
        description: Formulae to test dependents for
        required: false
        default: openssl@3
      brew_ref:
        description: Brew branch/tag/sha to test
        required: false
        default: feat/parrallel-deb-test
      dependent_shard_count:
        description: HOMEBREW_DEPENDENT_SHARD_COUNT
        required: false
        default: "4"

env:
  HOMEBREW_DEVELOPER: 1
  HOMEBREW_GITHUB_ACTIONS: 1
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_FROM_API: 1
  HOMEBREW_TEST_BOT_ANALYTICS: 0
  HOMEBREW_ENFORCE_SBOM: 1
  HOMEBREW_NO_BUILD_ERROR_ISSUES: 1
  GH_REPO: ${{github.repository}}
  GH_NO_UPDATE_NOTIFIER: 1
  GH_PROMPT_DISABLED: 1
  
jobs:
  tap_syntax:
    runs-on: ubuntu-latest
    steps:
      - run: true

  tests:
    runs-on: ubuntu-latest
    steps:
      - run: true

  formulae_detect:
    runs-on: ubuntu-latest
    outputs:
      testing_formulae: ${{ steps.vars.outputs.testing_formulae }}
    steps:
      - id: vars
        run: echo "testing_formulae=${{ inputs.testing_formulae }}" >> "$GITHUB_OUTPUT"

  setup_dep_tests:
    runs-on: ubuntu-latest
    outputs:
      syntax-only: "false"
      test-dependents: "true"
      fail-fast: "false"
      long-timeout: "false"
      linux-runner: "ubuntu-latest"
      download-concurrency: "4"
      test-bot-dependents-args: "--only-formulae-dependents"
    steps:
      - run: true

  setup_dep_runners:
    needs: [formulae_detect, setup_dep_tests]
    if: >
      !fromJson(needs.setup_dep_tests.outputs.syntax-only) &&
      fromJson(needs.setup_dep_tests.outputs.test-dependents)
    runs-on: ubuntu-latest
    outputs:
      runners: ${{ steps.filter-runners.outputs.runners }}
      runners_present: ${{ steps.filter-runners.outputs.runners_present }}
    env:
      HOMEBREW_LINUX_RUNNER: ${{ needs.setup_dep_tests.outputs.linux-runner }}
      HOMEBREW_MACOS_LONG_TIMEOUT: ${{ needs.setup_dep_tests.outputs.long-timeout }}
      HOMEBREW_DEPENDENT_SHARD_COUNT: ${{ inputs.dependent_shard_count }}
      TESTING_FORMULAE: ${{ needs.formulae_detect.outputs.testing_formulae }}
      TEST_BRANCH: ${{ inputs.brew_ref }}
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          core: true
          cask: false
        env:
          GITHUB_REPOSITORY: GunniBusch/brew

      - name: Switch Homebrew/brew to fork branch
        run: |
          cd "/home/linuxbrew/.linuxbrew/Homebrew"
          git remote remove userfork || true
          git remote add userfork https://github.com/GunniBusch/brew.git
          git fetch --force --tags userfork "$TEST_BRANCH"
          git checkout --force -B "$TEST_BRANCH" FETCH_HEAD

      - name: Determine runners to use for test_deps job
        id: determine-dependent-runners
        run: |
          brew determine-test-runners --dependents --eval-all "$TESTING_FORMULAE"

      - name: Filter to Linux matrix rows only
        id: filter-runners
        run: |
          all_runners='${{ steps.determine-dependent-runners.outputs.runners }}'
          linux_runners=$(echo "$all_runners" | ruby -rjson -e '
            rows = JSON.parse(STDIN.read)
            linux_rows = rows.select do |r|
              runner = r.fetch("runner")
              runner.start_with?("ubuntu") || runner.include?("linux")
            end
            puts linux_rows.to_json
          ')
          echo "runners=$linux_runners" >> "$GITHUB_OUTPUT"
          if [[ "$linux_runners" == "[]" ]]; then
            echo "runners_present=false" >> "$GITHUB_OUTPUT"
          else
            echo "runners_present=true" >> "$GITHUB_OUTPUT"
          fi

  test_deps:
    needs:
      [tap_syntax, formulae_detect, setup_dep_tests, setup_dep_runners, tests]
    if: >
      (success() ||
      (failure() &&
       !fromJson(needs.setup_dep_tests.outputs.fail-fast) &&
       !contains(fromJson('["skipped", "cancelled"]'), needs.tests.result))) &&
      !fromJson(needs.setup_dep_tests.outputs.syntax-only) &&
      fromJson(needs.setup_dep_tests.outputs.test-dependents) &&
      fromJson(needs.setup_dep_runners.outputs.runners_present)
    strategy:
      matrix:
        include: ${{ fromJson(needs.setup_dep_runners.outputs.runners) }}
      fail-fast: ${{ fromJson(needs.setup_dep_tests.outputs.fail-fast) }}
    name: ${{ matrix.name }} (deps shard ${{ matrix.dependent_shard_index }}/${{ matrix.dependent_shard_count }})
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    timeout-minutes: ${{ matrix.timeout }}
    defaults:
      run:
        shell: /bin/bash -xeuo pipefail {0}
        working-directory: ${{ matrix.workdir || github.workspace }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BOTTLES_DIR: ${{ matrix.workdir || github.workspace }}/bottles
      TESTING_FORMULAE: ${{ matrix.testing_formulae }}
      TEST_BRANCH: ${{ inputs.brew_ref }}
    steps:
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          core: true
          cask: false
        env:
          GITHUB_REPOSITORY: GunniBusch/brew

      - name: Switch Homebrew/brew to fork branch
        run: |
          cd "/home/linuxbrew/.linuxbrew/Homebrew"
          git remote remove userfork || true
          git remote add userfork https://github.com/GunniBusch/brew.git
          git fetch --force --tags userfork "$TEST_BRANCH"
          git checkout --force -B "$TEST_BRANCH" FETCH_HEAD

      - name: Test dependents
        run: |
          mkdir -p "$BOTTLES_DIR"
          cd "$BOTTLES_DIR"
          xargs -t brew test-bot \
            --dry-run \
            --testing-formulae="$TESTING_FORMULAE" \
            --tested-formulae="$TESTED_FORMULAE" \
            --dependent-shard-count="${{ matrix.dependent_shard_count }}" \
            --dependent-shard-index="${{ matrix.dependent_shard_index }}" \
            <<<"$TEST_BOT_DEPENDENTS_ARGS"
        env:
          HOMEBREW_DOWNLOAD_CONCURRENCY: ${{ needs.setup_dep_tests.outputs.download-concurrency }}
          TEST_BOT_DEPENDENTS_ARGS: ${{ needs.setup_dep_tests.outputs.test-bot-dependents-args }}
          TESTED_FORMULAE: ${{ needs.formulae_detect.outputs.testing_formulae }}
